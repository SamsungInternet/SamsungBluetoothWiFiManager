<svelte:head>
	<title>Connect</title>
</svelte:head>

<style>
	#connect {
		width: 100%;
	}
</style>

<h1>Setup <strong>Things</strong> <img src="logo-light.svg" alt="Things logo" width="50" height="50"/></h1>

{#if supported == false}
	<h2>Sorry</h2>

	<p>This service requires Web Bluetooth, which your browser does not support.</p>
	<p>Please use an alternative setup method or try again in a 
		<a href="https://caniuse.com/#feat=web-bluetooth">supporting browser</a> (such as Samsung Internet, Chrome or Opera).</p>

{:elseif supported}
	<h3>To setup your Gateway and configure it to use your wi-fi network, follow these steps.</h3>

	<h2>Step 1</h2>

	<p>Check your gateway is switched on and press the button to connect.</p>
	<button id="connect" on:click="onClickConnect()">Connect</button>

{/if}

<script>

	import { goto } from 'sapper/runtime.js';

	const WIFI_SETUP_SERVICE_UUID = '00010000-89bd-43c8-9231-40f6e305f96d';
	const WIFI_SSID_UUID = '00010001-89bd-43c8-9231-40f6e305f96d'; // Currently set SSID
	const WIFI_PASSWORD_UUID = '00010002-89bd-43c8-9231-40f6e305f96d';
	const WIFI_SECURITY_UUID = '00010003-89bd-43c8-9231-40f6e305f96d';
	const WIFI_SIDDS_LIST_UUID = '00010004-89bd-43c8-9231-40f6e305f96d';

	export default {
		data() {
			return {
				supported: null
			}
		},
		oncreate() {
			if (navigator.bluetooth && navigator.bluetooth.requestDevice) {
				this.set({supported: true});
			} else {
				this.set({supported: false});
			}
		},
		methods: {
			async onClickConnect() {

				const device = await navigator.bluetooth.requestDevice({
						filters: [{
							name: ['IoT Gateway WiFi Setup']
						}],
						optionalServices: [WIFI_SETUP_SERVICE_UUID]
					});

				console.log('device', device);

				const server = await device.gatt.connect();

				console.log('server', server);

				const service = await server.getPrimaryService(WIFI_SETUP_SERVICE_UUID);

				console.log('service', service);

				const characteristic = await service.getCharacteristic(WIFI_SIDDS_LIST_UUID);

				console.log('characteristic', characteristic);

				const value = await characteristic.readValue();		

				console.log('Wifi SSIDs value...', value);

				const array = new Uint8Array(value);

				console.log('array ', array, array.length, array.byteLength);

				for (let i=0; i < array.byteLength; i++) {
					console.log(i + ' : ' + array[i]);
				}

				// TODO replace dummy data with values we receive from Bluetooth
				this.store.set({wifiSSIDs: ['foo', 'bar', 'baz', 'lurman']})
					.then(() => {
						goto('/wifi');
					});

			}
		}
	};
</script>