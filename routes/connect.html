<svelte:head>
	<title>Connect</title>
</svelte:head>

<style>
	#connect {
		width: 100%;
	}
</style>

<h1>Setup <strong>Things</strong> <img src="logo-light.svg" alt="Things logo" width="50" height="50"/></h1>

<h2>Step 2</h2>

{#if unsupported}
	<p>Sorry, this service requires Web Bluetooth, which your browser does not appear to support.</p>
	<p>Please use an alternative setup method or try again in a 
		<a href="https://caniuse.com/#feat=web-bluetooth">supporting browser</a> (such as Samsung Internet, Chrome or Opera).</p>
{/if}

{#if supported}
	<p>Check your gateway is switched on and press the button to connect.</p>
	<button id="connect" on:click="onClickConnect()">Connect</button>		
{/if}

<p class="back"><a href="/">Back to previous page</a></p>

<script>

	export default {
		data() {
			return {
				supported: false,
				unsupported: false
			}
		},
		oncreate() {
			if (navigator.bluetooth && navigator.bluetooth.requestDevice) {
				this.set({supported: true});
			} else {
				this.set({unsupported: true});
			}
		},
		methods: {
			async onClickConnect() {
				// TODO replace battery_service (using temporarily for testing)
				const device = await navigator.bluetooth.requestDevice({
						filters: [{
							services: ['battery_service']
						}]
					});
				const server = await device.gatt.connect();
				const service = await server.getPrimaryService('battery_service');
				const characteristic = await service.getCharacteristic('battery_level');
				const value = await characteristic.readValue();		

				alert('Battery level is ' + value.getUint8(0));
			}
		}
	};
</script>